{% extends "base.html" %}
{% block title %}Emergency | Voice It Out{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto text-center px-4">

    <div class="mb-8 relative inline-block">
        <span class="absolute top-0 left-0 w-full h-full rounded-full bg-red-600 animate-ping opacity-75"></span>
        <div class="relative bg-gradient-to-br from-red-600 to-red-800 text-white rounded-full h-28 w-28 flex items-center justify-center text-5xl shadow-2xl mx-auto border-4 border-red-400">
            ðŸ†˜
        </div>
    </div>

    <h1 class="text-4xl font-extrabold text-white mb-2 tracking-wider uppercase">Emergency Assistance</h1>
    <p class="text-lg text-red-200 mb-8 font-medium">
        Kenyan Emergency Services. Help is a tap away.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
        <a href="tel:999" class="group bg-slate-900/60 hover:bg-red-600 border border-red-600/50 p-6 rounded-2xl shadow-lg transition duration-300 flex items-center justify-between">
            <div class="text-left">
                <h3 class="text-2xl font-bold text-white group-hover:text-white">Police / Ambulance</h3>
                <p class="text-red-300 group-hover:text-red-100 text-sm">National Emergency</p>
            </div>
            <span class="text-3xl font-black text-white bg-red-600/20 px-4 py-2 rounded-lg group-hover:bg-white group-hover:text-red-600 transition">999</span>
        </a>

        <a href="tel:1195" class="group bg-slate-900/60 hover:bg-purple-600 border border-purple-600/50 p-6 rounded-2xl shadow-lg transition duration-300 flex items-center justify-between">
            <div class="text-left">
                <h3 class="text-2xl font-bold text-white group-hover:text-white">GBV Helpline</h3>
                <p class="text-purple-300 group-hover:text-purple-100 text-sm">24/7 Confidential Support</p>
            </div>
            <span class="text-3xl font-black text-white bg-purple-600/20 px-4 py-2 rounded-lg group-hover:bg-white group-hover:text-purple-600 transition">1195</span>
        </a>
    </div>

    <div class="backdrop-blur-md bg-slate-900/70 border border-white/10 p-8 rounded-2xl max-w-2xl mx-auto shadow-2xl relative overflow-hidden">

        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-blue-600 rounded-full opacity-20 blur-3xl"></div>

        <h3 class="text-2xl font-bold text-white mb-2">Share Live Location</h3>
        <p class="text-slate-400 text-sm mb-6">
            Generate a secure Google Maps link to send to your trusted contacts via WhatsApp or SMS.
        </p>

        <button id="get-location-btn" onclick="getLocation()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold transition shadow-lg flex items-center justify-center gap-2 mx-auto">
            <span id="btn-icon"></span> <span id="btn-text">Detect My Location</span>
        </button>

        <div id="location-actions" class="hidden mt-6 space-y-4 animate-fade-in-up">
            <p class="text-green-400 text-sm font-mono bg-green-900/20 py-2 rounded border border-green-500/30">
                 Location Found: <span id="lat-display"></span>, <span id="long-display"></span>
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <a id="whatsapp-link" href="#" target="_blank" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition">
                    Share on WhatsApp
                </a>

                <a id="maps-link" href="#" target="_blank" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition">
                     Open in Maps
                </a>
            </div>
        </div>

        <p id="location-error" class="hidden mt-4 text-red-400 text-sm bg-red-900/20 p-2 rounded"></p>
    </div>

</div>

<script>
function getLocation() {
    const btnText = document.getElementById('btn-text');
    const btnIcon = document.getElementById('btn-icon');
    const errorMsg = document.getElementById('location-error');

    // UI Feedback: Loading state
    btnText.innerText = "Locating...";
    btnIcon.classList.add('animate-spin');
    errorMsg.classList.add('hidden');

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
        showError({ message: "Geolocation is not supported by this browser." });
    }
}

function showPosition(position) {
    const lat = position.coords.latitude;
    const long = position.coords.longitude;

    // Stop loading animation
    document.getElementById('btn-text').innerText = "Update Location";
    document.getElementById('btn-icon').classList.remove('animate-spin');

    // Reveal the Action Buttons
    document.getElementById('location-actions').classList.remove('hidden');

    // Update Display Text
    document.getElementById('lat-display').innerText = lat.toFixed(5);
    document.getElementById('long-display').innerText = long.toFixed(5);

    // 1. Create Google Maps Link
    const mapsUrl = `https://www.google.com/maps?q=${lat},${long}`;
    document.getElementById('maps-link').href = mapsUrl;

    // 2. Create WhatsApp Link (Pre-filled message)
    // "I need help. Here is my current location: [Link]"
    const message = `SOS! I need help. Here is my current location: ${mapsUrl}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    document.getElementById('whatsapp-link').href = whatsappUrl;
}

function showError(error) {
    const errorMsg = document.getElementById('location-error');
    document.getElementById('btn-text').innerText = "Detect My Location";
    document.getElementById('btn-icon').classList.remove('animate-spin');

    errorMsg.classList.remove('hidden');
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMsg.innerText = "You denied the request for Geolocation.";
            break;
        case error.POSITION_UNAVAILABLE:
            errorMsg.innerText = "Location information is unavailable.";
            break;
        case error.TIMEOUT:
            errorMsg.innerText = "The request to get user location timed out.";
            break;
        default:
            errorMsg.innerText = " An unknown error occurred.";
    }
}
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

{% endblock %}